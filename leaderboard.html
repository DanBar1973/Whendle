<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Whendle ‚Äî Leaderboard</title>
<style>
  :root { --bg:#0f1115; --card:#151923; --text:#e8ecf1; --muted:#9aa3b2; --accent:#60a5fa; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0f1115;color:var(--text)}
  .container{max-width:900px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  nav a{color:var(--text);text-decoration:none;padding:6px 10px;border:1px solid #263043;border-radius:10px;background:#0f1420}
  .card{background:#151923;border:1px solid #1f2634;border-radius:16px;padding:16px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:10px 12px}
  tr{background:#0e1320;border:1px solid #1f2634}
  tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child, tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #263043;background:#0f1420;color:var(--muted);cursor:pointer}
  .pill.active{background:#2563eb;color:white;border-color:#1e40af}
  <div style="display:flex;gap:8px;margin:8px 0 12px;justify-content:flex-end;">
    <button id="changeHandle" class="btn-ghost">Change handle</button>
  </div>
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
  .modal .inner{background:#151923;border:1px solid #1f2634;border-radius:12px;padding:16px;max-width:420px;width:94%}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #263043;background:#0f1420;color:var(--text)}
  button{background:linear-gradient(180deg,#3b82f6,#2563eb);border:1px solid #1e40af;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn-ghost{background:#0f1420;border:1px solid #263043;color:var(--text)}
  .hint{font-size:.9rem}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 style="margin:0;font-size:1.4rem;">üèÜ Whendle ‚Äî Leaderboard</h1>
    <nav>
      <a href="/index.html">Births</a>
      <a href="/events.html">Events</a>
    </nav>
  </header>

  <div class="card">
    <div id="meta" class="muted" style="margin-bottom:8px;"></div>
<div id="myStats" style="display:none; margin:8px 0 12px; display:flex; gap:8px; flex-wrap:wrap;">
  <span class="pill"><strong id="streakCurrent">0</strong> Current Streak</span>
  <span class="pill"><strong id="streakMax">0</strong> Max Streak</span>
  <span class="pill"><strong id="winsTotal">0</strong> Total Wins</span>
  <span class="pill"><strong id="winPct">0%</strong> Win %</span>
</div>

    <!-- Handle notice appears if user has no handle -->
    <div id="handleNotice" class="muted hint" style="display:none;margin:8px 0 12px;">
      Want to appear on the board? <button id="openHandle" class="btn-ghost" style="margin-left:8px;">Pick a handle</button>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <span class="pill active" id="scopeGlobal">Global</span>
      <span class="pill" id="scopeMyCountry">My Country</span>
    </div>
    <table>
      <thead><tr><th>#</th><th>Player</th><th>Tries</th><th>Time</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <div id="empty" class="muted" style="display:none;margin-top:8px;">No results yet.</div>
  </div>
</div>


<script type="module">
  
import { supabase, getDeviceId, fetchCountry, ensureUser, flagEmoji, getDailyStats, safeDisplayHandle } from "/js/db.js";

const params = new URLSearchParams(location.search);
const type = params.get("type") || "births"; // births | events

// UI elements
const scopeGlobal = document.getElementById("scopeGlobal");
const scopeMyCountry = document.getElementById("scopeMyCountry");
const meta = document.getElementById("meta");
const rowsEl = document.getElementById("rows");
const emptyEl = document.getElementById("empty");
const handleNotice = document.getElementById("handleNotice");
const handleModal = document.getElementById("handleModal");
const handleInput = document.getElementById("handleInput");
const handleError = document.getElementById("handleError");
const openHandleBtn = document.getElementById("openHandle");
const saveHandleBtn = document.getElementById("saveHandle");
const cancelHandleBtn = document.getElementById("cancelHandle");
const changeHandleBtn = document.getElementById("changeHandle");

let myCountry = null;

  // --- pretty date helpers ---
function ordinal(n){const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]);}
function prettyDateFromSeed(seed){
  // seed like "20250824|births" ‚Üí "24th August 2025"
  const y = Number(seed.slice(0,4)), m = Number(seed.slice(4,6))-1, d = Number(seed.slice(6,8));
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  return `${ordinal(d)} ${months[m]} ${y}`;
}
function niceType(t){ return t === "events" ? "Events" : "Births"; }

  
let userId = null;
let myHandle = null;

function msFmt(ms){
  if(!ms && ms!==0) return "‚Äî";
  const s=(ms/1000);
  return s<60 ? s.toFixed(1)+"s" : (Math.floor(s/60)+"m "+Math.round(s%60)+"s");
}

function setRows(list){
  rowsEl.innerHTML = "";
  if (!list || !list.length) { emptyEl.style.display="block"; return; }
  emptyEl.style.display="none";
  list.forEach((r,i)=>{
    const tr = document.createElement("tr");
    const flag = r.country ? flagEmoji(r.country) : "üè≥Ô∏è";
    const name = safeDisplayHandle(r.handle);
    tr.innerHTML = `<td>${i+1}</td>
                    <td>${flag} ${name}</td>
                    <td>${r.tries}</td>
                    <td>${msFmt(r.ms_elapsed)}</td>`;
rowsEl.appendChild(tr);
  });
}

function renderMyStats(s) {
  const box = document.getElementById("myStats");
  if (!box) return;
  document.getElementById("streakCurrent").textContent = s.currentStreak;
  document.getElementById("streakMax").textContent     = s.maxStreak;
  document.getElementById("winsTotal").textContent     = s.totalWins;
  document.getElementById("winPct").textContent        = (s.winPct || 0) + "%";
  box.style.display = "flex";
}

function todaySeedFor(type){
  const d = new Date();
  const seed = Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`);
  return `${seed}|${type}`;
}

async function loadLeaderboard(scope){
  const seed = todaySeedFor(type);
  const title = niceType(type);
const pretty = prettyDateFromSeed(seed);
meta.textContent = `${title} ‚Äî ${pretty}`;

let query = supabase.from("games")
  .select("tries, ms_elapsed, users:users(handle, country)") // keep the inner join alias
  .eq("game_type", type)
  .eq("run_mode", "daily")
  .eq("seed", seed)
  .eq("won", true)
  .order("tries", { ascending: true })
  .order("ms_elapsed", { ascending: true, nullsFirst: false }) // shows timed runs first
  .not("ms_elapsed", "is", null) // üëà filter out null times
  .limit(100);
  

if (scope === "country" && myCountry) {
  query = query.eq("users.country", myCountry);
}

  const { data, error } = await query;
  if (error) { console.error(error); setRows([]); return; }
  const rows = data.map(d => ({
    handle: d.users.handle,
    country: d.users.country,
    tries: d.tries,
    ms_elapsed: d.ms_elapsed
  }));
  setRows(rows);
}

function showHandleModal(show=true){
  handleModal.style.display = show ? "flex" : "none";
  if (show) {
    handleInput.value = myHandle || "";
    handleError.textContent = "";
    setTimeout(()=>handleInput.focus(), 0);
  }
}

function validateHandle(h){
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(h)) {
    return "Handle must be 3‚Äì20 chars: letters, numbers, underscore.";
  }
  // tiny profanity guard (expand later or use a lib)
  const bad = ["fuck","shit","cunt","nazi","hitler","rape", "wanker"];
  const lower = h.toLowerCase();
  if (bad.some(b => lower.includes(b))) return "Keep it clean. Please choose a different handle.";
  return null;
}

async function ensureHandlePrompt(){
  // Read current user's handle
  const { data, error } = await supabase.from("users").select("handle").eq("id", userId).maybeSingle();
  if (error) { console.error(error); return; }
  myHandle = data?.handle || null;
  handleNotice.style.display = myHandle ? "none" : "block";
}

async function saveHandle(){
  const h = (handleInput.value || "").trim();
  const err = validateHandle(h);
  if (err) { handleError.textContent = err; return; }

  const { error } = await supabase.from("users").update({ handle: h }).eq("id", userId);
  if (error) {
    if ((error.code === "23505") || /duplicate/i.test(error.message)) {
      handleError.textContent = "That handle is taken. Try another.";
    } else {
      handleError.textContent = "Could not save handle. Please try again.";
      console.error(error);
    }
    return;
  }
  myHandle = h;
  handleNotice.style.display = "none";
  showHandleModal(false);
  // Reload board so your new name appears if you‚Äôre on it
  const activeCountry = scopeMyCountry.classList.contains("active");
  await loadLeaderboard(activeCountry ? "country" : "global");
}

async function init(){
  const deviceId = getDeviceId();
  myCountry = await fetchCountry();
  userId = await ensureUser(deviceId, myCountry);
  await ensureHandlePrompt();
  try {
  const stats = await getDailyStats(userId, type); // type = 'births' | 'events'
  renderMyStats(stats);
} catch (e) {
  console.warn("stats load failed", e);
}

  await loadLeaderboard("global");
}

scopeGlobal.addEventListener("click", ()=>{
  scopeGlobal.classList.add("active");
  scopeMyCountry.classList.remove("active");
  loadLeaderboard("global");
});
scopeMyCountry.addEventListener("click", ()=>{
  scopeGlobal.classList.remove("active");
  scopeMyCountry.classList.add("active");
  loadLeaderboard("country");
});

openHandleBtn.addEventListener("click", ()=>showHandleModal(true));
cancelHandleBtn.addEventListener("click", ()=>showHandleModal(false));
saveHandleBtn.addEventListener("click", saveHandle);
handleInput.addEventListener("keydown", e => { if (e.key === "Enter") saveHandle(); });
changeHandleBtn?.addEventListener("click", ()=>showHandleModal(true));

init();
  const pickHandleBtn = document.getElementById("pickHandleBtn");

async function promptForHandle() {
  // `myHandle` and `userId` already exist in your script; if not, define:
  // let myHandle = myHandle ?? null;

  const h = (prompt("Choose a leaderboard handle (3‚Äì20 letters/numbers/_):", myHandle || "") || "").trim();
  if (!h) return;

  // basic validation
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(h)) {
    alert("Handle must be 3‚Äì20 chars: letters, numbers, underscore.");
    return;
  }

  // tiny profanity guard (same list as before)
  const bad = ["fuck","shit","cunt","nazi","hitler","rape"];
  const lower = h.toLowerCase();
  if (bad.some(b => lower.includes(b))) {
    alert("Please choose a different handle.");
    return;
  }

  const { error } = await supabase.from("users").update({ handle: h }).eq("id", userId);
  if (error) {
    alert("Could not save handle. Try another.");
    console.error(error);
    return;
  }

  myHandle = h;           // reflect locally
  await loadLeaderboard(  // refresh visible table
    document.getElementById("scopeMyCountry")?.classList.contains("active") ? "country" : "global"
  );
}

pickHandleBtn.addEventListener("click", promptForHandle);

</script>
  <button id="pickHandleBtn"
  style="
    position:fixed; right:16px; bottom:16px; z-index:50;
    background:linear-gradient(180deg,#3b82f6,#2563eb);
    border:1px solid #1e40af; color:white; font-weight:700;
    padding:12px 14px; border-radius:999px; cursor:pointer;
    box-shadow:0 10px 20px rgba(0,0,0,.35);
  "
  type="button"
>
  Change Your Handle ‚úèÔ∏è
</button>

</body>
</html>
