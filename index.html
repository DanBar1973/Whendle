<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Whendle ‚Äî Births (Bornle)</title>
<style>
  :root { --bg:#0f1115; --card:#151923; --text:#e8ecf1; --muted:#9aa3b2; --accent:#60a5fa; --green:#22c55e; --amber:#f59e0b; --red:#ef4444; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 900px at 20% -10%,#1b2130 0%,var(--bg) 60%);color:var(--text);display:grid;place-items:start center;min-height:100vh;padding:16px}
  .container{width:min(860px,100%)} header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  nav a{color:var(--text);text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid #1f2634;background:#0f1420}
  nav a.active{border-color:#2563eb;color:#93c5fd}
  .card{background:linear-gradient(180deg,#1a2231,var(--card));border:1px solid #1f2634;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}.col{display:grid;gap:8px;flex:1 1 300px}.muted{color:var(--muted)}
  img.portrait{width:100%;border-radius:12px;border:1px solid #263043;object-fit:cover;aspect-ratio:16/10;object-position:50% 18%;background:#0c0e14}
  input[type=text]{background:#0f1420;color:var(--text);border:1px solid #263043;padding:10px 12px;border-radius:10px;width:120px;font-size:1.1rem;letter-spacing:1px}
  button{background:linear-gradient(180deg,#3b82f6,#2563eb);border:1px solid #1e40af;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#0f1420;border:1px solid #263043;color:var(--text)}
  .lamps{display:flex;gap:12px;font-weight:700}.lamp{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px}
  .lamp.green{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.35)}.lamp.amber{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.35)}.lamp.red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.35)}
  .grid{display:grid;gap:8px;margin-top:12px}.guess-row{display:grid;align-items:center;gap:10px;padding:10px;grid-template-columns:auto 1fr auto;border:1px solid #20283a;border-radius:12px;background:#0e1320}
  .year{font-weight:800;letter-spacing:1px}.hint{min-width:120px;text-align:left;color:var(--muted);font-size:.9rem}.status{margin-top:10px;font-weight:700}.success{color:var(--green)}.error{color:var(--red)}
  h2.title{margin:4px 0 2px 0;font-size:1.35rem}
  .rules{margin:0;padding-left:18px}.rules li{margin:2px 0}

  /* Learn-more button */
.learnmore-btn{
  position:fixed; right:16px; bottom:16px; z-index:50;
  background:linear-gradient(180deg,#3b82f6,#2563eb);
  border:1px solid #1e40af; color:white; font-weight:700;
  padding:12px 14px; border-radius:999px; cursor:pointer; display:none;
  box-shadow:0 10px 20px rgba(0,0,0,.35);
}
.learnmore-btn.pulse{ animation:pulse 1.2s ease-in-out infinite; }
@keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

/* Modal */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; z-index:60;
}
.modal{
  position:fixed; inset:0; display:none; place-items:center; z-index:61;
}
.modal > .panel{
  width:min(760px,92%); background:linear-gradient(180deg,#1a2231,#141a26);
  border:1px solid #1f2634; border-radius:16px; padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.5); color:var(--text);
}
.modal .head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
.modal .head h3{ margin:0; font-size:1.1rem; }
.modal .close{ background:#0f1420; border:1px solid #263043; color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer; }
.modal .body{ white-space:pre-wrap; line-height:1.45; font-size:.95rem; color:var(--text); }
.modal .foot{ display:flex; justify-content:flex-end; margin-top:12px; }
.modal a.wiki{ color:#93c5fd; text-decoration:none; font-weight:700; }
.modal a.wiki:hover{ text-decoration:underline; }

h1 .calendar-icon {
  font-size: 1.1em;   /* slightly smaller than surrounding text */
  line-height: 1;     /* avoid cropping */
  vertical-align: middle;
}

  
  .cal-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 0.7em;        /* smaller than the 1.4rem h1 */
  line-height: 1;
  margin-right: 6px;       /* space between badge and title */
  background: #2563eb;
  color: white;
  border-radius: 6px;
  padding: 2px 4px;
}
.cal-month {
  font-size: 0.6em;
  text-transform: uppercase;
}
.cal-day {
  font-size: 1.2em;
  font-weight: 700;
}


/* Win pop + portrait glow (optional) */
.status.success{ animation: win-pop 800ms ease-out; text-shadow:0 0 12px rgba(34,197,94,.55); }
@keyframes win-pop{ 0%{transform:scale(.96);opacity:.6} 60%{transform:scale(1.06);opacity:1} 100%{transform:scale(1)} }
.portrait.win-glow{ box-shadow:0 0 0 0 rgba(34,197,94,.6); animation:ring 2.4s ease-out 1; }
@keyframes ring{ 0%{box-shadow:0 0 0 0 rgba(34,197,94,.7)} 60%{box-shadow:0 0 0 14px rgba(34,197,94,0)} 100%{box-shadow:0 0 0 0 rgba(34,197,94,0)} }

/* Emoji confetti pieces */
.confetti{
  position:fixed;
  left:0; top:0; width:100vw; height:100vh;
  pointer-events:none; z-index:70; overflow:hidden;
}
.confetti span{
  position:absolute; font-size:20px; will-change:transform,opacity;
  animation: fall 1800ms ease-out forwards;
}
@keyframes fall{
  0%{ transform: translate(var(--x,0), calc(var(--y,0) - 20px)) scale(1.2) rotate(0deg); opacity:1; }
  100%{ transform: translate(var(--x,0), calc(var(--y,0) - 120px)) scale(1) rotate(25deg); opacity:0; }
}

</style>
</head>
<body>
<div class="container">
  <header>
    <h1 style="font-size:1.4rem;margin:0;">
  <span class="cal-badge" aria-label="Today">
    <span class="cal-month" id="calMonth"></span>
    <span class="cal-day" id="calDay"></span>
  </span>
  Whendle ‚Äî Births (Bornle)
</h1>

    <nav>
      <a class="active" href="/index.html">Births</a>
      <a href="/events.html">Events</a>
    </nav>
  </header>

  <div class="card">
    <div class="row">
      <div class="col">
        <img class="portrait" id="portrait" alt="" src="" referrerpolicy="no-referrer" crossorigin="anonymous">
      </div>
      <div class="col">
        <h2 id="title" class="title">Person Name</h2>
        <ul class="rules muted">
          <li>Guess the <strong>4-digit year of birth</strong>.</li>
          <li>You get <strong>6 tries</strong>.</li>
          <li>Coloured lamps show digit count:</li>
          <li>üü© right number, right place</li>
          <li>üü® right number, wrong place</li>
          <li>üü• wrong number</li>
          <li><em>Warmer</em>üî• / <em>Cooler</em>üßä compares to your previous guess (ties show ‚ÄúNo change ‚óºÔ∏é‚Äù).</li>
        </ul>
        <div class="controls" style="margin-top:8px;">
          <label class="muted" for="mode">Mode</label>
          <select id="mode"><option>Daily</option><option>Practice</option></select>
          <label><input type="checkbox" id="hintToggle" checked> Warmer/Cooler</label>
          <input id="yearInput" type="text" inputmode="numeric" pattern="\\d{4}" placeholder="e.g. 1879" maxlength="4">
          <button id="submitBtn">Submit guess</button>
          <button id="newRound" class="secondary">New round</button>
        </div>
        <div id="status" class="status"></div>
        <div id="history" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="reveal" class="card" style="display:none; margin-top:12px;">
    <div style="font-size:.9rem;background:#0f1420;border:1px solid #1f2634;color:var(--muted);padding:6px 10px;border-radius:999px;display:inline-block;">About this person</div>
    <div id="summary" style="margin-top:8px;white-space:pre-wrap;line-height:1.45;"></div>
  </div>
</div>

<script>
const PEOPLE=[
 {name:"Albert Einstein",year:1879,img:"https://upload.wikimedia.org/wikipedia/commons/d/d3/Albert_Einstein_Head.jpg",summary:"Albert Einstein (1879‚Äì1955) was a German-born theoretical physicist who developed the theory of relativity and made foundational contributions to quantum mechanics."},
 {name:"Marie Curie",year:1867,img:"https://upload.wikimedia.org/wikipedia/commons/7/7e/Marie_Curie_c._1920s.jpg",summary:"Marie Sk≈Çodowska Curie (1867‚Äì1934) was a pioneering physicist and chemist, the first woman to win a Nobel Prize and the only person to win in two different sciences."},
 {name:"William Shakespeare",year:1564,img:"https://upload.wikimedia.org/wikipedia/commons/a/a2/Shakespeare.jpg",summary:"William Shakespeare (1564‚Äì1616) was an English playwright and poet, widely regarded as the greatest writer in the English language."},
 {name:"Nelson Mandela",year:1918,img:"https://upload.wikimedia.org/wikipedia/commons/0/0c/Nelson_Mandela-2008_%28edit%29.jpg",summary:"Nelson Mandela (1918‚Äì2013) was a South African anti-apartheid revolutionary and statesman who served as President of South Africa (1994‚Äì1999)."},
 {name:"Ada Lovelace",year:1815,img:"https://upload.wikimedia.org/wikipedia/commons/0/0f/Ada_Lovelace_portrait.jpg",summary:"Ada Lovelace (1815‚Äì1852) was an English mathematician often regarded as the first computer programmer for her work on Charles Babbage‚Äôs Analytical Engine."},
 {name:"Beyonc√©",year:1981,img:"https://upload.wikimedia.org/wikipedia/commons/1/18/Beyonc%C3%A9_-_Crazy_in_Love%2C_2011.jpg",summary:"Beyonc√© (born 1981) is an American singer, songwriter, and performer, one of the best-selling music artists of all time."},
 {name:"Lionel Messi",year:1987,img:"https://upload.wikimedia.org/wikipedia/commons/2/29/Lionel-Messi-Argentina-2022-FIFA-World-Cup.jpg",summary:"Lionel Messi (born 1987) is an Argentine professional footballer widely regarded as one of the greatest players of all time."},
 {name:"Taylor Swift",year:1989,img:"https://upload.wikimedia.org/wikipedia/commons/f/f2/Taylor_Swift_Reputation_Stadium_Tour3_%28cropped%29.jpg",summary:"Taylor Swift (born 1989) is an American singer-songwriter known for narrative songwriting and record-breaking tours."},
 {name:"Isaac Newton",year:1643,img:"https://upload.wikimedia.org/wikipedia/commons/d/d4/Sir_Isaac_Newton_%281642-1727%29.jpg",summary:"Isaac Newton (1643‚Äì1727) was an English mathematician, physicist, and astronomer who formulated the laws of motion and universal gravitation."},
 {name:"Nikola Tesla",year:1856,img:"https://upload.wikimedia.org/wikipedia/commons/d/d4/N.Tesla.JPG",summary:"Nikola Tesla (1856‚Äì1943) was a Serbian-American inventor and engineer known for AC power systems and numerous innovations."}
];
function ensureDisplayName(){
  try {
    const KEY = 'whendle_display_name';
    let name = localStorage.getItem(KEY);
    if (!name){
      name = prompt("Pick a display name for the leaderboard:", "")?.trim();
      if (name) localStorage.setItem(KEY, name);
    }
    return name || "Player";
  } catch { return "Player"; }
}

function pad4(n){return n.toString().padStart(4,"0");}
function score(a,g){const m=[0,1,2,3].map(i=>a[i]===g[i]);const greens=m.filter(Boolean).length;const ra={},rg={};for(let i=0;i<4;i++){if(!m[i]){ra[a[i]]=(ra[a[i]]||0)+1;rg[g[i]]=(rg[g[i]]||0)+1}}let amb=0;for(const d in rg){amb+=Math.min(rg[d]||0,ra[d]||0)}const red=4-greens-amb;return{green:greens,amber:amb,red:red}}
function lampHTML(r){return`<div class="lamps"><span class="lamp green">üü© ${r.green}</span><span class="lamp amber">üü® ${r.amber}</span><span class="lamp red">üü• ${r.red}</span></div>`}
function temperatureHint(ans,prev,nw){const pa=Math.abs(ans-prev),ca=Math.abs(ans-nw);if(ca<pa)return"Warmer üî•";if(ca>pa)return"Cooler üßä";return"No change ‚óºÔ∏é"}
function todaySeedNumber(){const d=new Date();return Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`);}
function todayIndex(){return todaySeedNumber()%PEOPLE.length}

// deterministic ‚Äúpractice pool‚Äù that excludes today (archive-ish)
function rng(seed){let x=seed|0;return()=>{x^=x<<13;x^=x>>>17;x^=x<<5;return((x>>>0)/4294967296)}}
function practicePool(count=14){
  const today=todayIndex();
  const d=new Date(); const monthSeed=Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}`);
  const rand=rng(monthSeed);
  const indices=[...Array(PEOPLE.length).keys()].filter(i=>i!==today);
  indices.sort(()=>rand()-0.5);
  return indices.slice(0, Math.min(count, indices.length));
}

let state={mode:"Daily",person:null,answer:"",guesses:[],results:[],over:false,win:false,startedAt:null};


function setImageWithFallback(el,src){
  el.onerror=()=>{el.style.objectFit='contain';el.style.background='#0e1320';};
  el.src=src;
}
async function fetchWikiMeta(title) {
  try {
    const url = "https://en.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(title);
    const r = await fetch(url, { mode: "cors" });
    if (!r.ok) return null;
    const d = await r.json();
    return {
      extract: d?.extract || "",
      image: (d?.originalimage?.source || d?.thumbnail?.source) || null
    };
  } catch { return null; }
}

function setPortrait(imgEl, src, altText) {
  imgEl.referrerPolicy = "no-referrer";
  imgEl.crossOrigin = "anonymous";
  imgEl.onerror = () => {
    imgEl.style.objectFit = "contain";
    imgEl.style.background = "#0e1320";
    imgEl.alt = altText || "Image unavailable";
  };
  imgEl.src = src;
}
function commonsThumb(url, width=800){
  try{
    const u = new URL(url);
    if (!u.hostname.includes('upload.wikimedia.org')) return null;
    // /wikipedia/commons/1/10/Name.jpg ‚Üí /wikipedia/commons/thumb/1/10/Name.jpg/800px-Name.jpg
    const m = u.pathname.match(/^\/wikipedia\/commons\/(.+\/)([^/]+)$/);
    if (!m) return null;
    const dir = m[1], file = m[2];
    return `https://upload.wikimedia.org/wikipedia/commons/thumb/${dir}${file}/${width}px-${file}`;
  } catch { return null; }
}

function setPortraitWithFallback(imgEl, srcs, altText){
  imgEl.referrerPolicy = "no-referrer";
  imgEl.crossOrigin = "anonymous";
  imgEl.alt = altText || "";

  // Build a try-list: original ‚Üí 800px thumb ‚Üí 512px thumb
  const candidates = [];
  for (const s of srcs) {
    if (!s) continue;
    candidates.push(s);
    const t800 = commonsThumb(s, 800); if (t800) candidates.push(t800);
    const t512 = commonsThumb(s, 512); if (t512) candidates.push(t512);
  }

  let i = 0;
  const tryNext = () => {
    if (i >= candidates.length) {
      imgEl.style.objectFit = "contain";
      imgEl.style.background = "#0e1320";
      return;
    }
    imgEl.onerror = () => { i++; tryNext(); };
    imgEl.src = candidates[i];
  };
  tryNext();
}

(function initCalendarBadge(){
  const m = document.getElementById("calMonth");
  const d = document.getElementById("calDay");
  if (!m || !d) return;
  const now = new Date();
  m.textContent = now.toLocaleString(undefined, { month: "short" }).toUpperCase(); // e.g., AUG
  d.textContent = String(now.getDate()); // 1‚Äì31
})();

async function pickPerson(mode){
  let idx;
  if (mode==="Daily") {
    idx = todayIndex();
  } else { // Practice
    const pool = practicePool(14);
    idx = pool[Math.floor(Math.random()*pool.length)];
  }
  const p=PEOPLE[idx];
  state.person=p; state.answer=pad4(p.year); state.guesses=[]; state.results=[]; state.over=false; state.win=false; state.startedAt = performance.now();
  const img=document.getElementById("portrait");
document.getElementById("title").textContent = p.name;

  // Re-show the rules for a fresh round and hide the CTA until the end
const rules = document.querySelector('.rules');
if (rules) rules.style.display = '';
hideLearnMore();

document.title = `Whendle ‚Äî Births (${p.name})`;

// Try Wikipedia first
const meta = await fetchWikiMeta(p.name);
const imgSrc = meta?.image || p.img;
// OLD
// setPortrait(img, imgSrc, p.name);

// NEW
setPortraitWithFallback(img, [meta?.image, p.img], p.name);


// Save summary fallback into state
state.person.summary = meta?.extract || p.summary || "";

  document.getElementById("history").innerHTML=""; document.getElementById("status").textContent="";
  document.getElementById("reveal").style.display="none"; document.getElementById("summary").textContent="";
  document.getElementById("title").textContent=p.name; document.title=`Whendle ‚Äî Births (${p.name})`;
}

async function fetchSummary(name,fallback){
  try{
    const url="https://en.wikipedia.org/api/rest_v1/page/summary/"+encodeURIComponent(name);
    const r=await fetch(url,{mode:"cors"});
    if(r.ok){const d=await r.json(); if(d&&d.extract) return d.extract;}
  }catch(e){}
  return fallback||"";
}

function addHistoryRow(guess,res,hint){
  const row=document.createElement("div"); row.className="guess-row";
  const ht=(hint&&hint.trim())?hint:" ";
  row.innerHTML=`<div class="year">${guess}</div>${lampHTML(res)}<span class="hint">${ht}</span>`;
  document.getElementById("history").prepend(row);
}

function ensureLearnMoreUI(){
  if (ensureLearnMoreUI._wired) return;
  const btn      = document.getElementById('learnMoreBtn');
  const modal    = document.getElementById('summaryModal');
  const backdrop = document.getElementById('modalBackdrop');
  const closeBtn = document.getElementById('modalCloseBtn');
  if (!btn || !modal || !backdrop || !closeBtn) return;

  const close = () => { modal.style.display='none'; backdrop.style.display='none'; };
  btn.addEventListener('click', ()=>{ modal.style.display='grid'; backdrop.style.display='block'; btn.classList.remove('pulse'); });
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);

  window._lm = { btn, modal, backdrop };
  ensureLearnMoreUI._wired = true;
}
function hideLearnMore(){
  ensureLearnMoreUI();
  if (!window._lm) return;
  const { btn, modal, backdrop } = window._lm;
  btn.style.display='none'; btn.classList.remove('pulse');
  modal.style.display='none'; backdrop.style.display='none';
}
function showLearnMore({title, summary, wiki}){
  ensureLearnMoreUI();
  const { btn } = window._lm;
  const body = document.getElementById('modalBody');
  const link = document.getElementById('wikiLink');
  const heading = document.getElementById('modalTitle');
  heading.textContent = `Learn more ‚Äî ${title}`;
  body.textContent = summary || '(No summary available.)';
  link.href = wiki;
  btn.style.display='inline-block';
  btn.classList.add('pulse');
}

// (optional) tiny win effects
function celebrateWin(){
  const layer=document.createElement('div'); layer.className='confetti'; document.body.appendChild(layer);
  const emojis=['üéâ','‚ú®','üéä','üåü','ü•≥','‚úÖ'], W=innerWidth, H=innerHeight, pieces=26;
  for(let i=0;i<pieces;i++){ const s=document.createElement('span'); s.textContent=emojis[i%emojis.length];
    const x=(W/2)+(Math.random()*220-110), y=(H/2)+(Math.random()*80-40);
    s.style.left=x+'px'; s.style.top=y+'px';
    s.style.setProperty('--x',(Math.random()*320-160)+'px');
    s.style.setProperty('--y',(Math.random()*240+140)+'px');
    s.style.animationDelay=(Math.random()*0.15)+'s';
    layer.appendChild(s);
  }
  setTimeout(()=>layer.remove(), 2600);
}
function glowPortraitOnce(){
  const img=document.getElementById('portrait'); if(!img) return;
  img.classList.add('win-glow'); setTimeout(()=>img.classList.remove('win-glow'), 1200);
}

async function finishRound(){
  const s = document.getElementById("status");

  // compute once for both win/loss
  const msElapsed = Math.max(0, Math.round(performance.now() - (state.startedAt ?? performance.now())));
  const seconds = Math.round(msElapsed / 1000);

  if (state.win){
    s.className = "status success";
    s.textContent = `Correct! ${state.person.name} was born in ${state.answer}. (${state.guesses.length} ${state.guesses.length===1?'guess':'guesses'}, ${seconds}s)`;
    celebrateWin();
    glowPortraitOnce();
  } else {
    s.className = "status error";
    s.textContent = `Out of tries! The correct year was ${state.answer}. (${state.guesses.length} ${state.guesses.length===1?'guess':'guesses'}, ${seconds}s)`;
  }

  // ‚ÄúSee where you placed‚Äù
  const boardLink = document.createElement("a");
  boardLink.href="#";
  boardLink.addEventListener("click", (e)=>{ e.preventDefault(); window.openLeaderboardModal("global"); });
  boardLink.textContent = "See where you placed ‚Üí";
  boardLink.style.display = "inline-block";
  boardLink.style.marginTop = "8px";
  boardLink.style.color = "#60a5fa";
  boardLink.style.fontWeight = "600";
  s.appendChild(document.createElement("br"));
  s.appendChild(boardLink);

  // Attach modal opener instead of navigating away
  boardLink.addEventListener("click", (e) => {
    e.preventDefault();
    window.openLeaderboardModal?.("births"); // or "events" in events.html
  });
  
  // Learn‚Äëmore CTA (refresh summary silently, but keep card hidden)
  const t = await fetchSummary(state.person.name, state.person.summary);
  showLearnMore({
    title: state.person.name,
    summary: t || state.person.summary || "",
    wiki: `https://en.wikipedia.org/wiki/${encodeURIComponent(state.person.name)}`
  });

  // Hide instructions
  const rules = document.querySelector('.rules');
  if (rules) rules.style.display = 'none';

  // Record to Supabase
  try{
    const seed = `${todaySeedNumber()}|births`;
    const runMode = document.getElementById('mode').value === 'Daily' ? 'daily' : 'practice';
    if (window.onRoundFinished) {
      await window.onRoundFinished({
        gameType: 'births', runMode, seed,
        entityName: state.person.name, win: state.win, tries: state.guesses.length,
        msElapsed, results: state.results
      });
    }
  }catch(e){ console.warn("recordGame failed (non-fatal)", e); }
}


function submitGuess(){
  if(state.over)return;
  const inp=document.getElementById("yearInput"); const v=(inp.value||"").trim();
  const s=document.getElementById("status");
  if(!/^\d{4}$/.test(v)){ s.className="status"; s.textContent="Please enter exactly 4 digits (e.g., 1879)."; return; }
  let hint=""; if(document.getElementById("hintToggle").checked && state.guesses.length>0){
    hint=temperatureHint(Number(state.answer),Number(state.guesses[state.guesses.length-1]),Number(v));
  }
  const res=score(state.answer,v); state.guesses.push(v); state.results.push(res); addHistoryRow(v,res,hint); inp.value="";
  if(res.green===4){ state.over=true; state.win=true; finishRound(); }
  else if(state.guesses.length>=6){ state.over=true; state.win=false; finishRound(); }
}

document.getElementById("submitBtn").addEventListener("click", submitGuess);
document.getElementById("yearInput").addEventListener("keydown", e => { if (e.key === "Enter") submitGuess(); });
document.getElementById("newRound").addEventListener("click", () => { pickPerson(document.getElementById("mode").value); });
document.getElementById("mode").addEventListener("change", e => { pickPerson(e.target.value); });

// start a round
pickPerson(state.mode);

</script>

<!-- Supabase hook block -->
<script type="module">
 import {getDeviceId, fetchCountry, ensureUser, recordGame, buildShare, updateHandle, flagEmoji, getDailyStats} from "/js/db.js";

  const deviceId = getDeviceId();
  const country = await fetchCountry();
  const userId = await ensureUser(deviceId, country);
const displayName =
  (window.ensureDisplayName && window.ensureDisplayName()) || "Player";
await updateHandle(userId, displayName);


  // Expose to game script
  window.onRoundFinished = async ({ gameType, runMode, seed, entityName, win, tries, msElapsed, results }) => {
    await recordGame({ userId, gameType, runMode, seed, entityName, won: win, tries, msElapsed, rows: results });
    const shareText = buildShare({ title:`Whendle ‚Äî ${entityName}`, tries, won:win, rows:results, url:"https://whendle.org" });
    try{ await navigator.clipboard.writeText(shareText); }catch{}
  };

  // ‚Ä¶ all your game logic functions above ‚Ä¶

// Init game
pickPerson(state.mode);

// === Calendar Badge (today‚Äôs date) ===
(function updateCalendarBadge(){
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const d = new Date();
  const month = months[d.getMonth()];
  const day = d.getDate();
  document.getElementById("calMonth").textContent = month;
  document.getElementById("calDay").textContent = day;
})();
  

</script>

<script type ="module" id='lb-module">

// === Inline Leaderboard Modal wiring ===

const typeValue = "births"; // <-- change to "events" in events.html

// DOM refs
const lbBackdrop = document.getElementById("lbBackdrop");
const lbModal = document.getElementById("lbModal");
const lbCloseBtn = document.getElementById("lbCloseBtn");
const lbRows = document.getElementById("lbRows");
const lbEmpty = document.getElementById("lbEmpty");
const lbMeta = document.getElementById("lbMeta");
const lbScopeGlobal = document.getElementById("lbScopeGlobal");
const lbScopeMyCountry = document.getElementById("lbScopeMyCountry");
const lbMyStats = document.getElementById("lbMyStats");
const lbStreakCurrent = document.getElementById("lbStreakCurrent");
const lbStreakMax = document.getElementById("lbStreakMax");
const lbWinsTotal = document.getElementById("lbWinsTotal");
const lbWinPct = document.getElementById("lbWinPct");
const lbOpenFull = document.getElementById("lbOpenFull");

let _lb = { myCountry: null, userId: null };

function msFmt(ms){
  if(!ms && ms!==0) return "‚Äî";
  const s=(ms/1000);
  return s<60 ? s.toFixed(1)+"s" : (Math.floor(s/60)+"m "+Math.round(s%60)+"s");
}
function todaySeedFor(type){
  const d = new Date();
  const seed = Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`);
  return `${seed}|${type}`;
}
function setLbRows(list){
  lbRows.innerHTML = "";
  if (!list || !list.length) { lbEmpty.style.display="block"; return; }
  lbEmpty.style.display="none";
  list.forEach((r,i)=>{
    const tr = document.createElement("tr");
    const flag = r.country ? flagEmoji(r.country) : "üè≥Ô∏è";
    tr.innerHTML = `<td style="padding:10px 12px;">${i+1}</td>
                    <td style="padding:10px 12px;">${flag} ${r.handle||"Player"}</td>
                    <td style="padding:10px 12px;">${r.tries}</td>
                    <td style="padding:10px 12px;">${msFmt(r.ms_elapsed)}</td>`;
    lbRows.appendChild(tr);
  });
}
function renderMyStatsBox(stats){
  if (!stats) { lbMyStats.style.display="none"; return; }
  lbStreakCurrent.textContent = stats.currentStreak;
  lbStreakMax.textContent = stats.maxStreak;
  lbWinsTotal.textContent = stats.totalWins;
  lbWinPct.textContent = (stats.winPct||0) + "%";
  lbMyStats.style.display = "flex";
}

async function loadLb(scope){
  const seed = todaySeedFor(typeValue);
  lbMeta.textContent = `Mode: Daily ‚Ä¢ ${typeValue} ‚Ä¢ seed ${seed}` + (scope==="country" && _lb.myCountry ? ` ‚Ä¢ ${_lb.myCountry}` : "");
  lbOpenFull.href = `/leaderboard.html?type=${typeValue}`;

  let query = supabase.from("games")
    .select("tries, ms_elapsed, users:users(handle, country)")
    .eq("game_type", typeValue)
    .eq("run_mode", "daily")
    .eq("seed", seed)
    .eq("won", true)
    .order("tries", { ascending: true })
    .order("ms_elapsed", { ascending: true, nullsFirst: false })
    .not("ms_elapsed", "is", null)
    .limit(100);

  if (scope === "country" && _lb.myCountry) {
    query = query.eq("users.country", _lb.myCountry);
  }

  const { data, error } = await query;
  if (error) { console.error(error); setLbRows([]); return; }
  const rows = (data||[]).map(d => ({
    handle: d.users.handle,
    country: d.users.country,
    tries: d.tries,
    ms_elapsed: d.ms_elapsed
  }));
  setLbRows(rows);
}

async function openLeaderboardModal(scope="global"){
  try {
    // Reuse identity/country you already created in this module
    // (these exist in this module scope already)
    _lb.myCountry = country || null;   // 'country' is from your existing module vars
    _lb.userId = userId || null;       // 'userId' is from your existing module vars

    // Personal stats (for this type)
    const stats = _lb.userId ? await getDailyStats(_lb.userId, typeValue) : null;
    renderMyStatsBox(stats);

    // Load rows
    await loadLb(scope);

    // Toggle pills UI
    lbScopeGlobal.classList.toggle("active", scope === "global");
    lbScopeMyCountry.classList.toggle("active", scope === "country");

    // Show modal
    lbBackdrop.style.display = "block";
    lbModal.style.display = "grid";
  } catch (e) {
    console.warn("openLeaderboardModal failed", e);
  }
}
function closeLeaderboardModal(){
  lbBackdrop.style.display = "none";
  lbModal.style.display = "none";
}

// expose
window.openLeaderboardModal = openLeaderboardModal;

// events
lbBackdrop?.addEventListener("click", closeLeaderboardModal);
lbCloseBtn?.addEventListener("click", closeLeaderboardModal);
lbScopeGlobal?.addEventListener("click", ()=>{ lbScopeGlobal.classList.add("active"); lbScopeMyCountry.classList.remove("active"); openLeaderboardModal("global"); });
lbScopeMyCountry?.addEventListener("click", ()=>{ lbScopeGlobal.classList.remove("active"); lbScopeMyCountry.classList.add("active"); openLeaderboardModal("country"); });

// Expose modal open/close globally so game pages can call them
window.openLeaderboardModal = async function (gameType = "births") {
  // Show modal
  leaderboardModal.style.display = "flex";

  // Load the board scoped to this game type
  await loadLeaderboard("global", gameType);

  // You could also preload stats here if you want
};

window.closeLeaderboardModal = function () {
  leaderboardModal.style.display = "none";
};

</script>
  
<!-- Leaderboard Modal -->
<div id="lbBackdrop" class="modal-backdrop" style="display:none;"></div>
<div id="lbModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="lbTitle" style="display:none;">
  <div class="panel" style="max-width:820px;">
    <div class="head">
      <h3 id="lbTitle" style="margin:0;">Today‚Äôs Leaderboard</h3>
      <button class="close" id="lbCloseBtn" type="button">Close</button>
    </div>

    <!-- scope pills -->
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <span class="pill active" id="lbScopeGlobal">Global</span>
      <span class="pill" id="lbScopeMyCountry">My Country</span>
    </div>

    <!-- your stats -->
    <div id="lbMyStats" style="display:none; margin:4px 0 12px; display:flex; gap:8px; flex-wrap:wrap;">
      <span class="pill"><strong id="lbStreakCurrent">0</strong> Current Streak</span>
      <span class="pill"><strong id="lbStreakMax">0</strong> Max Streak</span>
      <span class="pill"><strong id="lbWinsTotal">0</strong> Total Wins</span>
      <span class="pill"><strong id="lbWinPct">0%</strong> Win %</span>
    </div>

    <!-- table -->
    <div class="card" style="padding:0; background:transparent; border:none;">
      <table style="width:100%;border-collapse:separate;border-spacing:0 8px;">
        <thead>
          <tr><th style="padding:10px 12px;">#</th><th style="padding:10px 12px;">Player</th><th style="padding:10px 12px;">Tries</th><th style="padding:10px 12px;">Time</th></tr>
        </thead>
        <tbody id="lbRows"></tbody>
      </table>
      <div id="lbEmpty" class="muted" style="display:none;margin-top:8px;">No results yet.</div>
    </div>

    <div class="foot" style="justify-content:space-between;">
      <a id="lbOpenFull" class="wiki" target="_blank" rel="noopener">Open full page ‚Üó</a>
      <div class="muted" id="lbMeta"></div>
    </div>
  </div>
</div>

<button id="learnMoreBtn" class="learnmore-btn" type="button">Learn more ‚Üó</button>
<div id="modalBackdrop" class="modal-backdrop"></div>
<div id="summaryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <div class="head">
      <h3 id="modalTitle">Learn more</h3>
      <button class="close" id="modalCloseBtn" type="button">Close</button>
    </div>
    <div id="modalBody" class="body"></div>
    <div class="foot">
      <a id="wikiLink" class="wiki" target="_blank" rel="noopener noreferrer">Open on Wikipedia ‚Üó</a>
    </div>
  </div>
</div>

</body>
</html>
