<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Whendle ‚Äî Events (Eventle)</title>
<style>
  :root { --bg:#0f1115; --card:#151923; --text:#e8ecf1; --muted:#9aa3b2; --accent:#60a5fa; --green:#22c55e; --amber:#f59e0b; --red:#ef4444; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 900px at 20% -10%,#1b2130 0%,var(--bg) 60%);color:var(--text);display:grid;place-items:start center;min-height:100vh;padding:16px}
  .container{width:min(860px,100%)} header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  nav a{color:var(--text);text-decoration:none;padding:6px 10px;border-radius:10px;border:1px solid #1f2634;background:#0f1420}
  nav a.active{border-color:#2563eb;color:#93c5fd}
  .card{background:linear-gradient(180deg,#1a2231,var(--card));border:1px solid #1f2634;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}.col{display:grid;gap:8px;flex:1 1 300px}.muted{color:var(--muted)}
  img.portrait{width:100%;border-radius:12px;border:1px solid #263043;object-fit:cover;aspect-ratio:16/10;object-position:50% 18%;background:#0c0e14}
  input[type=text]{background:#0f1420;color:var(--text);border:1px solid #263043;padding:10px 12px;border-radius:10px;width:120px;font-size:1.1rem;letter-spacing:1px}
  button{background:linear-gradient(180deg,#3b82f6,#2563eb);border:1px solid #1e40af;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#0f1420;border:1px solid #263043;color:var(--text)}
  .lamps{display:flex;gap:12px;font-weight:700}.lamp{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px}
  .lamp.green{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.35)}.lamp.amber{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.35)}.lamp.red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.35)}
  .grid{display:grid;gap:8px;margin-top:12px}.guess-row{display:grid;align-items:center;gap:10px;padding:10px;grid-template-columns:auto 1fr auto;border:1px solid #20283a;border-radius:12px;background:#0e1320}
  .year{font-weight:800;letter-spacing:1px}.hint{min-width:120px;text-align:left;color:var(--muted);font-size:.9rem}.status{margin-top:10px;font-weight:700}.success{color:var(--green)}.error{color:var(--red)}
  h2.title{margin:4px 0 2px 0;font-size:1.35rem}
  .rules{margin:0;padding-left:18px}.rules li{margin:2px 0}
  /* Learn-more button */
.learnmore-btn{
  position:fixed; right:16px; bottom:16px; z-index:50;
  background:linear-gradient(180deg,#3b82f6,#2563eb);
  border:1px solid #1e40af; color:white; font-weight:700;
  padding:12px 14px; border-radius:999px; cursor:pointer; display:none;
  box-shadow:0 10px 20px rgba(0,0,0,.35);
}
.learnmore-btn.pulse{ animation:pulse 1.2s ease-in-out infinite; }
@keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

/* Modal */
/* Backdrop that dims the screen */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  z-index:60;
}

/* Modal container (grid centers the panel) */
.modal{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  z-index:61;
}

/* Inner panel */
.modal > .panel{
  width:min(760px,92%);
  background:linear-gradient(180deg,#1a2231,#141a26);
  border:1px solid #1f2634;
  border-radius:16px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
  color:var(--text);
}

/* Header */
.modal .head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:8px;
}
.modal .head h3{
  margin:0;
  font-size:1.1rem;
}

/* Close button */
.modal .close{
  background:#0f1420;
  border:1px solid #263043;
  color:var(--text);
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
}

/* Body text */
.modal .body{
  white-space:pre-wrap;
  line-height:1.45;
  font-size:0.95rem;
  color:var(--text);
}

/* Footer with external link */
.modal .foot{
  display:flex;
  justify-content:flex-end;
  margin-top:12px;
}
.modal a.wiki{
  color:#93c5fd;
  text-decoration:none;
  font-weight:700;
}
.modal a.wiki:hover{
  text-decoration:underline;
}

/* Win pop + glow */
.status.success{
  animation: win-pop 800ms ease-out;
  text-shadow: 0 0 12px rgba(34,197,94,.55);
}
@keyframes win-pop{
  0%{ transform:scale(.96); opacity:.6 }
  60%{ transform:scale(1.06); opacity:1 }
  100%{ transform:scale(1); }
}

/* Portrait highlight on win */
.portrait.win-glow{
  box-shadow: 0 0 0 0 rgba(34,197,94,.6);
  animation: ring 2.4s ease-out 1;
}
@keyframes ring{
  0% { box-shadow: 0 0 0 0 rgba(34,197,94,.7) }
  60% { box-shadow: 0 0 0 14px rgba(34,197,94,0) }
  100% { box-shadow: 0 0 0 0 rgba(34,197,94,0) }
}

/* Emoji confetti pieces */
.confetti{
  position:fixed;
  left:0; top:0; width:100vw; height:100vh;
  pointer-events:none; z-index:70; overflow:hidden;
}
.confetti span{
  position:absolute; font-size:20px; will-change:transform,opacity;
  animation: fall 1800ms ease-out forwards;
}
@keyframes fall{
  0%{ transform: translate(var(--x,0), calc(var(--y,0) - 20px)) scale(1.2) rotate(0deg); opacity:1; }
  100%{ transform: translate(var(--x,0), calc(var(--y,0) - 120px)) scale(1) rotate(25deg); opacity:0; }
}

</style>
</head>
<body>
<div class="container">
  <header>
    <h1 style="font-size:1.4rem;margin:0;">üìÖ Whendle ‚Äî Events (Eventle)</h1>
    <nav>
      <a href="/index.html">Births</a>
      <a class="active" href="/events.html">Events</a>
    </nav>
  </header>

  <div class="card">
    <div class="row">
      <div class="col">
        <img class="portrait" id="portrait" alt="" src="" referrerpolicy="no-referrer" crossorigin="anonymous">
      </div>
      <div class="col">
        <h2 id="title" class="title">Event Name</h2>
        <ul class="rules muted">
          <li>Guess the <strong>4-digit year of this event </strong>.</li>
          <li>You get <strong>6 tries</strong>.</li>
          <li>Coloured lamps show digit count:</li>
          <li>üü© right number, right place</li>
          <li>üü® right number, wrong place</li>
          <li>üü• wrong number</li>
          <li><em>Warmer</em>üî• / <em>Cooler</em>üßä compares to your previous guess (ties show ‚ÄúNo change ‚óºÔ∏é‚Äù).</li>
        </ul>
        <div class="controls" style="margin-top:8px;">
          <label class="muted" for="mode">Mode</label>
          <select id="mode"><option>Daily</option><option>Practice</option></select>
          <label><input type="checkbox" id="hintToggle" checked> Warmer/Cooler</label>
          <input id="yearInput" type="text" inputmode="numeric" pattern="\\d{4}" placeholder="e.g. 1989" maxlength="4">
          <button id="submitBtn">Submit guess</button>
          <button id="newRound" class="secondary">New round</button>
        </div>
        <div id="status" class="status"></div>
        <div id="history" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="reveal" class="card" style="display:none; margin-top:12px;">
    <div style="font-size:.9rem;background:#0f1420;border:1px solid #1f2634;color:var(--muted);padding:6px 10px;border-radius:999px;display:inline-block;">About this event</div>
    <div id="summary" style="margin-top:8px;white-space:pre-wrap;line-height:1.45;"></div>
  </div>
</div>

<script>
const EVENTS=[
 {name:"Fall of the Berlin Wall",year:1989,img:"https://upload.wikimedia.org/wikipedia/commons/3/3f/Berlin_Wall_Brandenburger_Tor.jpg",summary:"The Berlin Wall fell in 1989, leading to German reunification and symbolizing the end of the Cold War."},
 {name:"First Moon Landing (Apollo 11)",year:1969,img:"https://upload.wikimedia.org/wikipedia/commons/a/a1/Aldrin_Apollo_11.jpg",summary:"Apollo 11 landed on the Moon in 1969; Neil Armstrong and Buzz Aldrin walked on the lunar surface."},
 {name:"World Wide Web proposed",year:1989,img:"https://upload.wikimedia.org/wikipedia/commons/5/5f/Tim_Berners-Lee%2C_Vienna_2009.jpg",summary:"Tim Berners-Lee proposed the World Wide Web in 1989 at CERN, leading to the modern web."},
 {name:"First Powered Flight (Wright Brothers)",year:1903,img:"https://upload.wikimedia.org/wikipedia/commons/a/a3/First_flight2.jpg",summary:"In 1903, the Wright brothers achieved the first powered, controlled flight at Kitty Hawk."},
 {name:"Penicillin discovered",year:1928,img:"https://upload.wikimedia.org/wikipedia/commons/4/4c/Alexander_Fleming_%281952%29.jpg",summary:"Alexander Fleming discovered penicillin in 1928, leading to the antibiotic era."},
 {name:"DNA double helix published",year:1953,img:"https://upload.wikimedia.org/wikipedia/commons/5/5c/DNA_model.png",summary:"Watson and Crick published the structure of DNA in 1953, based on crucial data from Rosalind Franklin and Maurice Wilkins."},
 {name:"Sputnik 1 launched",year:1957,img:"https://upload.wikimedia.org/wikipedia/commons/7/74/Sputnik_asm.jpg",summary:"The Soviet Union launched Sputnik 1 in 1957, the first artificial Earth satellite."},
 {name:"Magna Carta sealed",year:1215,img:"https://upload.wikimedia.org/wikipedia/commons/1/13/Magna_Carta_%28British_Library_Cotton_MS_Augustus_II.106%29.jpg",summary:"In 1215, Magna Carta limited the powers of the English king and influenced constitutional law."},
 {name:"American Declaration of Independence",year:1776,img:"https://upload.wikimedia.org/wikipedia/commons/6/6b/US_Declaration_of_Independence.jpg",summary:"The United States declared independence from Britain in 1776."},
 {name:"French Revolution begins (Storming of the Bastille)",year:1789,img:"https://upload.wikimedia.org/wikipedia/commons/1/10/Prise_de_la_Bastille.jpg",summary:"In 1789, the storming of the Bastille marked the start of the French Revolution."},
 {name:"Columbus reaches the Americas",year:1492,img:"https://upload.wikimedia.org/wikipedia/commons/7/7d/Columbus_Taking_Possession_of_the_New_Country.jpg",summary:"Christopher Columbus reached the Americas in 1492, initiating sustained European contact."},
 {name:"Printing press introduced in Europe (Gutenberg)",year:1450,img:"https://upload.wikimedia.org/wikipedia/commons/3/3e/Printing_press_from_1811.jpg",summary:"Around 1450, Gutenberg's movable-type printing press transformed information dissemination."},
 {name:"World War I begins",year:1914,img:"https://upload.wikimedia.org/wikipedia/commons/c/ce/German_infantry_1914.jpg",summary:"World War I began in 1914 following the July Crisis after the assassination of Archduke Franz Ferdinand."},
 {name:"World War II ends",year:1945,img:"https://upload.wikimedia.org/wikipedia/commons/4/49/Times_Square%2C_New_York_City_%28LOC_80-G-404522%29.jpg",summary:"World War II ended in 1945 with Allied victory in Europe and the Pacific."},
 {name:"First iPhone released",year:2007,img:"https://upload.wikimedia.org/wikipedia/commons/f/fa/IPhone_1st_Gen.svg",summary:"Apple released the first iPhone in 2007, catalyzing the smartphone era."}
];

  const WIKI_TITLE = {
  "World War I begins": "World War I",
  "Magna Carta sealed": "Magna Carta",
  "Penicillin discovered": "Alexander Fleming",
  "Sputnik 1 launched": "Sputnik 1",
  "Columbus reaches the Americas": "Voyages of Christopher Columbus",
  "World War II ends": "V-J Day in Times Square",
  "First Powered Flight (Wright Brothers)": "Wright Flyer",
  "DNA double helix published": "Double Helix" // broad page but reliably has an image
};

function pad4(n){return n.toString().padStart(4,"0");}
function score(a,g){const m=[0,1,2,3].map(i=>a[i]===g[i]);const greens=m.filter(Boolean).length;const ra={},rg={};for(let i=0;i<4;i++){if(!m[i]){ra[a[i]]=(ra[a[i]]||0)+1;rg[g[i]]=(rg[g[i]]||0)+1}}let amb=0;for(const d in rg){amb+=Math.min(rg[d]||0,ra[d]||0)}const red=4-greens-amb;return{green:greens,amber:amb,red:red}}
function lampHTML(r){return`<div class="lamps"><span class="lamp green">üü© ${r.green}</span><span class="lamp amber">üü® ${r.amber}</span><span class="lamp red">üü• ${r.red}</span></div>`}
function temperatureHint(ans,prev,nw){const pa=Math.abs(ans-prev),ca=Math.abs(ans-nw);if(ca<pa)return"Warmer üî•";if(ca>pa)return"Cooler üßä";return"No change ‚óºÔ∏é"}
function todaySeedNumber(){const d=new Date();return Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`);}
function todayIndex(){return todaySeedNumber()%EVENTS.length}

// practice pool excluding today
function rng(seed){let x=seed|0;return()=>{x^=x<<13;x^=x>>>17;x^=x<<5;return((x>>>0)/4294967296)}}
function practicePool(count=14){
  const today=todayIndex();
  const d=new Date(); const monthSeed=Number(`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}`);
  const rand=rng(monthSeed);
  const indices=[...Array(EVENTS.length).keys()].filter(i=>i!==today);
  indices.sort(()=>rand()-0.5);
  return indices.slice(0, Math.min(count, indices.length));
}

let state={mode:"Daily",item:null,answer:"",guesses:[],results:[],over:false,win:false};

async function fetchWikiMetaSmart(title) {
  // helper: REST summary (handles redirects; gives image, thumb, extract, page URL)
  const rest = async (t) => {
    const u = "https://en.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(t);
    const r = await fetch(u, { mode: "cors" });
    if (!r.ok) return null;
    const d = await r.json();
    return {
      pageTitle: d?.title || t,
      extract: d?.extract || "",
      image: d?.originalimage?.source || null,
      thumb: d?.thumbnail?.source || null,
      page: d?.content_urls?.desktop?.page || (`https://en.wikipedia.org/wiki/${encodeURIComponent(t)}`)
    };
  };

  // 1) exact try
  const exact = await rest(title);
  if (exact) return exact;

  // 2) search fallback
  try {
    const searchUrl =
      "https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=" +
      encodeURIComponent(title) +
      "&utf8=1&format=json&origin=*";
    const sr = await fetch(searchUrl, { mode: "cors" });
    if (sr.ok) {
      const js = await sr.json();
      const best = js?.query?.search?.[0]?.title;
      if (best) {
        const viaSearch = await rest(best);
        if (viaSearch) return viaSearch;
      }
    }
  } catch {}

  return null;
}



function setPortrait(imgEl, src, altText) {
  imgEl.referrerPolicy = "no-referrer";
  imgEl.crossOrigin = "anonymous";
  imgEl.onerror = () => {
    imgEl.style.objectFit = "contain";
    imgEl.style.background = "#0e1320";
    imgEl.alt = altText || "Image unavailable";
  };
  imgEl.src = src;
}
function commonsThumb(url, width = 800){
  try{
    const u = new URL(url);
    if (!u.hostname.includes('upload.wikimedia.org')) return null;

    // If it's already a /thumb/ URL, don't touch it.
    if (/^\/wikipedia\/commons\/thumb\//.test(u.pathname)) return url;

    // e.g. /wikipedia/commons/1/10/File.svg  or  /wikipedia/commons/1/10/File.jpg
    const m = u.pathname.match(/^\/wikipedia\/commons\/(.+\/)([^/]+)$/);
    if (!m) return null;
    const dir = m[1], file = m[2];

    const isSvg = /\.svg$/i.test(file);
    const tail = isSvg ? `${width}px-${file}.png` : `${width}px-${file}`;

    return `https://upload.wikimedia.org/wikipedia/commons/thumb/${dir}${file}/${tail}`;
  } catch { return null; }
}

function setPortraitWithFallback(imgEl, srcs, altText){
  imgEl.referrerPolicy = "no-referrer";
  imgEl.crossOrigin = "anonymous";
  imgEl.alt = altText || "";

  const seen = new Set();
  const candidates = [];
  for (const s of srcs) {
    if (!s || seen.has(s)) continue;
    seen.add(s);
    candidates.push(s);

    const t800 = commonsThumb(s, 800);
    if (t800 && !seen.has(t800)) { seen.add(t800); candidates.push(t800); }

    const t512 = commonsThumb(s, 512);
    if (t512 && !seen.has(t512)) { seen.add(t512); candidates.push(t512); }
  }

  let i = 0;
  const tryNext = () => {
    if (i >= candidates.length) {
      imgEl.style.objectFit = "contain";
      imgEl.style.background = "#0e1320";
      return;
    }
    imgEl.onerror = () => { i++; tryNext(); };
    imgEl.src = candidates[i];
  };
  console.debug("Image candidates:", candidates);
  tryNext();
}

async function pickEvent(mode) {
  // 1) choose index
  let idx;
  if (mode === "Daily") {
    idx = todayIndex();
  } else {
    const pool = practicePool(14);
    idx = pool[Math.floor(Math.random() * pool.length)];
  }

  // 2) set state for new round
  const p = EVENTS[idx];
  state.item   = p;
  state.answer = pad4(p.year);
  state.guesses = [];
  state.results = [];
  state.over = false;
  state.win  = false;

  // 3) reset UI
  const imgEl = document.getElementById("portrait");
  document.getElementById("history").innerHTML = "";
  document.getElementById("status").textContent = "";
  document.getElementById("reveal").style.display = "none";
  document.getElementById("summary").textContent = "";

  // 4) set heading/title
  document.getElementById("title").textContent = p.name;
  document.title = `Whendle ‚Äî Events (${p.name})`;

  // 5) show rules again; hide Learn More UI for fresh round
  const rules = document.querySelector(".rules");
  if (rules) rules.style.display = "";
  hideLearnMore();

  // 6) pick best wiki title to query
  const qTitle = (typeof WIKI_TITLE !== "undefined" && WIKI_TITLE[p.name]) ? WIKI_TITLE[p.name] : p.name;

  // 7) fetch wiki meta (robust to failures)
  let meta = null;
  try {
    meta = await fetchWikiMetaSmart(qTitle);
  } catch (e) {
    console.warn("fetchWikiMetaSmart failed:", e);
  }

  // 8) build image candidates: API thumb ‚Üí API original ‚Üí curated fallback
  const sources = [];
  if (meta?.thumb) sources.push(meta.thumb);
  if (meta?.image) sources.push(meta.image);
  if (p.img)       sources.push(p.img);

  // final safety: always try at least the curated image
  if (!sources.length && p.img) sources.push(p.img);

  console.debug("Using wiki page:", meta?.pageTitle || qTitle, "Image candidates:", sources);
  setPortraitWithFallback(imgEl, sources, p.name);

  // 9) store summary + wiki link for the modal
  state.item.summary = meta?.extract || p.summary || "";
  state.item.wiki    = meta?.page || (`https://en.wikipedia.org/wiki/${encodeURIComponent(p.name)}`);
}


// tiny confetti (no deps)
function celebrateWin(){
  const layer = document.createElement('div');
  layer.className = 'confetti';
  document.body.appendChild(layer);

  const emojis = ['üéâ','‚ú®','üéä','üåü','ü•≥','‚úÖ'];
  const W = window.innerWidth, H = window.innerHeight;
  const pieces = 26;

  for (let i=0;i<pieces;i++){
    const s = document.createElement('span');
    s.textContent = emojis[i % emojis.length];
    const x = (W/2) + (Math.random()*220 - 110);
    const y = (H/2) + (Math.random()*80 - 40);
    s.style.left = x + 'px';
    s.style.top = y + 'px';
    s.style.setProperty('--x', (Math.random()*320 - 160) + 'px');
    s.style.setProperty('--y', (Math.random()*240 + 140) + 'px');
    s.style.animationDelay = (Math.random()*0.15) + 's';
    layer.appendChild(s);
  }

  // cleanup
  setTimeout(()=> layer.remove(), 2600);
}

function glowPortraitOnce(){
  const img = document.getElementById('portrait');
  if (!img) return;
  img.classList.add('win-glow');
  setTimeout(()=> img.classList.remove('win-glow'), 1200);
}
async function fetchSummary(name,fallback){
  try{const url="https://en.wikipedia.org/api/rest_v1/page/summary/"+encodeURIComponent(name);
      const r=await fetch(url,{mode:"cors"}); if(r.ok){const d=await r.json(); if(d&&d.extract)return d.extract}}catch(e){}
  return fallback||"";
}

function addHistoryRow(guess,res,hint){
  const row=document.createElement("div"); row.className="guess-row";
  const ht=(hint&&hint.trim())?hint:" ";
  row.innerHTML=`<div class="year">${guess}</div>${lampHTML(res)}<span class="hint">${ht}</span>`;
  document.getElementById("history").prepend(row);
}
function ensureLearnMoreUI(){
  // wire once
  if (ensureLearnMoreUI._wired) return;
  ensureLearnMoreUI._wired = true;

  const btn = document.getElementById('learnMoreBtn');
  const modal = document.getElementById('summaryModal');
  const backdrop = document.getElementById('modalBackdrop');
  const closeBtn = document.getElementById('modalCloseBtn');

  const close = () => {
    modal.style.display = 'none';
    backdrop.style.display = 'none';
  };

  btn.addEventListener('click', () => {
    modal.style.display = 'grid';
    backdrop.style.display = 'block';
    // stop pulsing when opened
    btn.classList.remove('pulse');
  });
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);

  // expose
  window._lm = { btn, modal, backdrop };
}

function hideLearnMore(){
  ensureLearnMoreUI();
  const { btn, modal, backdrop } = window._lm;
  btn.style.display = 'none';
  btn.classList.remove('pulse');
  modal.style.display = 'none';
  backdrop.style.display = 'none';
}

function showLearnMore({title, summary, wiki}){
  ensureLearnMoreUI();
  const { btn } = window._lm;
  const body = document.getElementById('modalBody');
  const link = document.getElementById('wikiLink');
  const heading = document.getElementById('modalTitle');

  heading.textContent = `Learn more ‚Äî ${title}`;
  body.textContent = summary || '(No summary available.)';
  link.href = wiki;

  btn.style.display = 'inline-block';
  btn.classList.add('pulse');
}

async function finishRound(){
  const s = document.getElementById("status");
  if (state.win) {
    s.className = "status success";
    s.textContent = `Correct! ‚Äú${state.item.name}‚Äù happened in ${state.answer}.`;
      celebrateWin();
  glowPortraitOnce();
  } else {
    s.className = "status error";
    s.textContent = `Out of tries! The correct year was ${state.answer}.`;
 // Hide instructions so results + CTA are more prominent
const rules = document.querySelector('.rules');
if (rules) rules.style.display = 'none';
 }

  // ‚ÄúSee where you placed‚Äù ‚Üí Events board
  const boardLink = document.createElement("a");
  boardLink.href = `/leaderboard.html?type=events`;
  boardLink.textContent = "See where you placed ‚Üí";
  boardLink.style.display = "inline-block";
  boardLink.style.marginTop = "8px";
  boardLink.style.color = "#60a5fa";
  boardLink.style.fontWeight = "600";
  s.appendChild(document.createElement("br"));
  s.appendChild(boardLink);

  // Button show for reveal (already fetched in pickEvent)
  showLearnMore({
  title: state.item.name,
  summary: state.item.summary,
  wiki: state.item.wiki
});


  // Record result (Supabase hook, if you added onRoundFinished in your module script)
  try {
    const seed = `${todaySeedNumber()}|events`;
    const runMode = document.getElementById('mode').value === 'Daily' ? 'daily' : 'practice';
    if (window.onRoundFinished) {
      await window.onRoundFinished({
        gameType: 'events',
        runMode,
        seed,
        entityName: state.item.name,
        win: state.win,
        tries: state.guesses.length,
        msElapsed: null,
        results: state.results
      });
    }
  } catch (e) {
    console.warn("recordGame failed (non-fatal)", e);
  }
}

function submitGuess(){
  if(state.over)return;
  const inp=document.getElementById("yearInput"); const v=(inp.value||"").trim();
  const s=document.getElementById("status");
  if(!/^\d{4}$/.test(v)){ s.className="status"; s.textContent="Please enter exactly 4 digits (e.g., 1989)."; return; }
  let hint=""; if(document.getElementById("hintToggle").checked && state.guesses.length>0){
    hint=temperatureHint(Number(state.answer),Number(state.guesses[state.guesses.length-1]),Number(v));
  }
  const res=score(state.answer,v); state.guesses.push(v); state.results.push(res); addHistoryRow(v,res,hint); inp.value="";
  if(res.green===4){ state.over=true; state.win=true; finishRound(); }
  else if(state.guesses.length>=6){ state.over=true; state.win=false; finishRound(); }
}

document.getElementById("submitBtn").addEventListener("click",submitGuess);
document.getElementById("yearInput").addEventListener("keydown",e=>{if(e.key==="Enter")submitGuess()});
document.getElementById("newRound").addEventListener("click", async ()=>{await pickEvent(document.getElementById("mode").value)});
document.getElementById("mode").addEventListener("change", async e=>{await pickEvent(e.target.value)});
pickEvent(state.mode);
</script>

<!-- Supabase hook block -->
<script type="module">
  import { getDeviceId, fetchCountry, ensureUser, recordGame, buildShare } from "/js/db.js";

  const deviceId = getDeviceId();
  const country = await fetchCountry();
  const userId = await ensureUser(deviceId, country);

  window.onRoundFinished = async ({ gameType, runMode, seed, entityName, win, tries, msElapsed, results }) => {
    await recordGame({ userId, gameType, runMode, seed, entityName, won: win, tries, msElapsed, rows: results });
    const shareText = buildShare({ title:`Whendle ‚Äî ${entityName}`, tries, won:win, rows:results, url:"https://whendle.org" });
    try{ await navigator.clipboard.writeText(shareText); }catch{}
  };
</script>
  <button id="learnMoreBtn" class="learnmore-btn" type="button">Learn more ‚Üó</button>
<div id="modalBackdrop" class="modal-backdrop"></div>
<div id="summaryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="panel">
    <div class="head">
      <h3 id="modalTitle">Learn more</h3>
      <button class="close" id="modalCloseBtn" type="button">Close</button>
    </div>
    <div id="modalBody" class="body"></div>
    <div class="foot">
      <a id="wikiLink" class="wiki" target="_blank" rel="noopener noreferrer">Open on Wikipedia ‚Üó</a>
    </div>
  </div>
</div>

</body>
</html>
